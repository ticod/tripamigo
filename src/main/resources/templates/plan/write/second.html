<!DOCTYPE html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org"
	  th:replace="~{/fragment/layout :: layout(~{::title}, ~{::section}, ~{::style})}">
  <title>WRITE PLAN 2</title>
  <style>
	  section {
		  display: flex;
		  flex-direction: column;
		  justify-content: center;
		  align-content: center;
	  }

	  .property {
		  margin-top: 100px;
		  height: 500px;
	  }

	  .property > div {
		  /*width: 60%;*/
	  }

	  .sidebar-plan {
		  z-index: 1;

		  position:fixed;
		  top: 1rem;
		  right: 1rem;

		  padding: 1rem;
	  }

	  .sidebar-plan * {
		  font-size: 0.75rem;
	  }
  </style>
<body>
<!-- Main Contents -->
<section class="w3-container">

	<!-- Plan Detail Table -->
	<div class="w3-dropdown-click">
		<button class="w3-button" onclick="detailPlanDropDown()">지금까지 작성한 일정 보기</button>
		<div id="detail_plan_table" class="detail_plan_table w3-dropdown-content">
			<div>
				<p>asdf</p>
				<p>asdf</p>
			</div>
		</div>
	</div>
	<!-- Plan Detail Table END -->

	<!-- 세부 일정 입력 폼 (Period Form) -->
	<form th:action="@{second}" method="post">

		<div class="w3-card w3-round w3-padding">
			<h3>세부 일정 시작 시간을 선택하세요!</h3>

			<select name="startYear" id="startYear">
				<option value="">연도</option>
			</select>
			<label for="startYear" class="w3-margin-right">년</label>

			<select name="startMonth" id="startMonth">
				<option value="">월</option>
			</select>
			<label for="startMonth" class="w3-margin-right">월</label>

			<select name="startDay" id="startDay">
				<option value="">일</option>
			</select>
			<label for="startDay" class="w3-margin-right">일</label>

			<select name="startTime" id="startTime">
				<option value="">시각</option>
			</select>
			<label for="startTime">시</label>

			<br> <br> <br>

			<h3>세부 일정 종료 시간을 선택하세요!</h3>

			<select name="endYear" id="endYear">
				<option value="">연도</option>
			</select>
			<label for="endYear" class="w3-margin-right">년</label>

			<select name="endMonth" id="endMonth">
				<option value="">월</option>
			</select>
			<label for="endMonth" class="w3-margin-right">월</label>

			<select name="endDay" id="endDay">
				<option value="">일</option>
			</select>
			<label for="endDay" class="w3-margin-right">일</label>

			<select name="endTime" id="endTime">
				<option value="">시각</option>
			</select>
			<label for="endTime">시</label>
		</div>

		<div class="property w3-border w3-row w3-margin w3-padding">
			<div class="w3-col s6 w3-padding">
				<label for="place_search">장소 검색: </label>
				<input type="text" class="w3-input"
					   style="width: 80%;"
					   id="place_search" placeholder="검색하세요">
				<button type="button"
						id="place_search_button"
						class="w3-button w3-border w3-indigo
						w3-hover-white w3-hover-text-indigo w3-hover-border-indigo">
					검색
				</button>
				<div class="map w3-border" id="map"></div>
			</div>
			<div class="w3-col s6 w3-center w3-padding">
				<div id="place_name">선택 장소 명</div>

				<br>

				<div>평균 예산</div>
				<div id="place_budget">정보 없음</div>

				<br>

				<div>평균 별점</div>
				<div id="place_rating">정보 없음</div>

				<br>

				<div>추천지 리스트</div>
				<div class="w3-row" id="recommend_place">
					<div class="w3-col s4 w3-border">추천지 1</div>
					<div class="w3-col s4 w3-border">추천지 2</div>
					<div class="w3-col s4 w3-border">추천지 3</div>
				</div>
			</div>
		</div>

		<div class="property w3-border w3-row w3-margin w3-padding">
			<div class="map w3-col s3 w3-border">구글 맵 api 들어갈 자리</div>
			<div class="map w3-col s3 w3-border">구글 맵 api 들어갈 자리</div>
			<div class="map w3-col s6 w3-border">교통편 (direction api)</div>
		</div>

		<div>
			<label for="budget">예상 지출액: </label>
			<input type="text" class="w3-input" id="budget" name="budget">
		</div>

		<div>
			<label for="memo">해당 일정에 대한 메모를 입력해주세요! <br></label>
			<textarea name="memo" id="memo" class="w3-input w3-border" cols="40" rows="8" style="resize: none;"></textarea>
		</div>

		<br> <br> <br>

		<div class="w3-card sidebar-plan w3-white">

			<div class="w3-container">
				<p>1. 전체 일정 고르기</p>
				<b>2. 세부 일정 쌓기</b>
				<p>3. 글 작성하기</p>
			</div>

			<input type="button" class="w3-button w3-round w3-border"
				   value="이전 단계로" onclick="location.href='first'">
			<br>
			<input type="button" class="w3-button w3-round w3-border"
				   value="일정 추가 작성">
			<br>
			<input type="submit" class="w3-button w3-round w3-border"
				   value="다음 단계로">

		</div>

	</form>

	<script>
		document.addEventListener('keydown', function(event) {
			if (event.keyCode === 13) {
				event.preventDefault();
			};
		}, true);

		function detailPlanDropDown() {
			var table = document.getElementById("detail_plan_table");
			if (table.className.indexOf("w3-show") === -1) {
				table.className += " w3-show";
			} else {
				table.className = table.className.replace(" w3-show", "");
			}
		}
		class App {
			constructor() {
				this.idStartYear = document.getElementById("startYear");
				this.idStartMonth = document.getElementById("startMonth");
				this.idStartDay = document.getElementById("startDay");
				this.idStartTime = document.getElementById("startTime")

				this.idEndYear = document.getElementById("endYear");
				this.idEndMonth = document.getElementById("endMonth");
				this.idEndDay = document.getElementById("endDay");
				this.idEndTime = document.getElementById("endTime")

				const now = new Date();
				this.years = this.range(now.getFullYear(), now.getFullYear() + 1);
				this.valueAppendChildTo(this.idStartYear, this.years);
				this.valueAppendChildTo(this.idEndYear, this.years);

				this.times = this.range(1, 24);
				this.valueAppendChildTo(this.idStartTime, this.times);
				this.valueAppendChildTo(this.idEndTime, this.times);

				this.idStartYear.addEventListener('change', this.changeMonthByYear.bind(this));
				this.idStartMonth.addEventListener('change', this.changeDayByMonth.bind(this));

				this.idEndYear.addEventListener('change', this.changeEndMonthByYear.bind(this));
				this.idEndMonth.addEventListener('change', this.changeEndDayByMonth.bind(this));
			}

			range(start, end) {
				return Array(end - start + 1).fill(start).map((x, y) => x + y)
			}

			valueAppendChildTo(target, values) {
				target.options.length = 1;
				for (const value in values) {
					const option = document.createElement("option");
					option.text = values[value].toString();
					option.value = values[value].toString();
					target.appendChild(option)
				}
			}

			changeMonthByYear(event) {
				if (!isNaN(event.target.value) || event.target.value === "") {
					const now = new Date();
					let months;
					// 연이 같으면 이번 달 부터 출력
					if (now.getFullYear() === parseInt(event.target.value)) {
						months = this.range(now.getMonth() + 1, 12);
					} else {
						months = this.range(1, 12);
					}
					this.valueAppendChildTo(this.idStartMonth, months);
				}
			}

			changeDayByMonth(event) {
				if (!isNaN(event.target.value) || event.target.value === "") {
					const selectYear = parseInt(this.idStartYear.value);
					const selectMonth = parseInt(event.target.value);
					const now = new Date();
					let days;
					// 연, 월이 같으면 오늘 날짜부터 출력
					// 월의 경우 0 ~ 11이므로 +1부터 비교
					if (now.getFullYear() === selectYear
							&& (now.getMonth() + 1) === selectMonth) {
						days = this.range(now.getDate(), this.getLastDay(selectYear, selectMonth) + 1)
					} else {
						days = this.range(1, this.getLastDay(selectYear, selectMonth) + 1)
					}

					this.valueAppendChildTo(this.idStartDay, days);
				}
			}

			changeEndMonthByYear(event) {
				if (!isNaN(event.target.value) || event.target.value === "") {
					const now = new Date();
					let months;
					// 연이 같으면 이번 달 부터 출력
					if (now.getFullYear() === parseInt(event.target.value)) {
						months = this.range(now.getMonth() + 1, 12);
					} else {
						months = this.range(1, 12);
					}
					this.valueAppendChildTo(this.idEndMonth, months);
				}
			}

			changeEndDayByMonth(event) {
				if (!isNaN(event.target.value) || event.target.value === "") {
					const selectYear = parseInt(this.idEndYear.value);
					const selectMonth = parseInt(event.target.value);
					const now = new Date();
					let days;
					// 연, 월이 같으면 오늘 날짜부터 출력
					// 월의 경우 0 ~ 11이므로 +1부터 비교
					if (now.getFullYear() === selectYear
							&& (now.getMonth() + 1) === selectMonth) {
						days = this.range(now.getDate(), this.getLastDay(selectYear, selectMonth) + 1)
					} else {
						days = this.range(1, this.getLastDay(selectYear, selectMonth) + 1)
					}

					this.valueAppendChildTo(this.idEndDay, days);
				}
			}

			getLastDay(year, month) {
				return new Date(year, month, -1).getDate()
			}
		}

		window.onload = () => new App();

	</script>

	<!-- Google Map API -->
	<script async
			src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDml_UQ416dl6gnchPflJMtoqvdh9m5CRw&libraries=places&callback=initMap">
	</script>
	<script>
		const placeSearch = document.getElementById("place_search");
		const placeName = document.getElementById("place_name");
		const placeBudget = document.getElementById("place_budget");
		const placeRating = document.getElementById("place_rating");

		let map;
		let service;

		function initMap() {

			const seoul = { lat: 37.552, lng: 126.991 };
			const map = new google.maps.Map(document.getElementById("map"), {
				zoom: 12,
				center: seoul,
			});
			let service = new google.maps.places.PlacesService(map);

			document.getElementById("place_search_button")
					.addEventListener('click', () => {
						service.findPlaceFromQuery({
							query: placeSearch.value,
							fields: ['formatted_address', 'name', 'geometry', 'place_id']
						}, function(results, status) {
							if (status === google.maps.places.PlacesServiceStatus.OK) {
								console.log(results[0].geometry.location.lat());
								console.log(results[0].geometry.location.lng());
								placeName.innerText = results[0].formatted_address + "\n" + results[0].name;
								map.setCenter(results[0].geometry.location);
								$.ajax({
									url: "/area/summary",
									type: "POST",
									dataType: 'text',
									data: {
										"address": results[0].formatted_address,
										"placeName": results[0].name
									},
									success: function(res) {
										const summary = JSON.parse(res);
										if (!isNaN(summary.budgetAvg)) {
											placeBudget.innerText = summary.budgetAvg;
										} else {
											placeBudget.innerText = "정보 없음";
										}

										if (!isNaN(summary.ratingAvg)) {
											placeRating.innerText = summary.ratingAvg;
										} else {
											placeRating.innerText = "정보 없음";
										}
									},
									error: function(res) {
										alert("에러!");
									}
								});
							} else {
								alert("검색 결과가 없습니다.");
							}
						});
					});
		}

		function createMarker(place) {
			if (!place.geometry || !place.geometry.location) return;
			const marker = new google.maps.Marker({
				map,
				position: place.geometry.location,
			});
			google.maps.event.addListener(marker, "click", () => {
				infowindow.setContent(place.name || "");
				infowindow.open(map);
			});
		}
	</script>
<!--	<script th:inline="javascript" th:src="@{script/google_map.js}"></script>-->
</section>

</body>
</html>